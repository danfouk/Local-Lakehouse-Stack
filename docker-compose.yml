version: "3.9"

services:

  # ---------------------------------------------------------
  # Nessie Catalog Server (RocksDB)
  # ---------------------------------------------------------
  nessie:
    image: projectnessie/nessie:latest
    container_name: nessie
    environment:
      - QUARKUS_PROFILE=prod
      - QUARKUS_HTTP_PORT=19120
      - QUARKUS_LOG_LEVEL=INFO
      - QUARKUS_DATASOURCE_DB_KIND=rocksdb
      - QUARKUS_DATASOURCE_JDBC_URL=jdbc:rocksdb:file:///nessie/data
      - QUARKUS_DATASOURCE_USERNAME=nessie
      - QUARKUS_DATASOURCE_PASSWORD=nessie
    volumes:
      - ./nessie-data:/nessie/data
    ports:
      - "19120:19120"
    networks:
      - intro-network

  # ---------------------------------------------------------
  # Nessie UI
  # ---------------------------------------------------------
  nessie-ui:
    image: ghcr.io/projectnessie/nessie-ui:latest
    container_name: nessie-ui
    environment:
      - NESSIE_API_URL=http://nessie:19120/api/v1
    ports:
      - "19121:80"
    depends_on:
      - nessie
    networks:
      - intro-network

  # ---------------------------------------------------------
  # MinIO (single-node)
  # ---------------------------------------------------------
  minio:
    image: minio/minio
    container_name: minio
    environment:
      - MINIO_ROOT_USER=admin
      - MINIO_ROOT_PASSWORD=password
      - MINIO_REGION_NAME=us-east-1
      - MINIO_REGION=us-east-1
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - ./minio-data:/data
      # TLS (optional)
      # - ./certs/public.crt:/root/.minio/certs/public.crt
      # - ./certs/private.key:/root/.minio/certs/private.key
    networks:
      - intro-network

  # ---------------------------------------------------------
  # MinIO Bootstrap (buckets + IAM policies)
  # ---------------------------------------------------------
  minio-init:
    image: minio/mc
    container_name: minio-init
    depends_on:
      - minio
    entrypoint: >
      /bin/sh -c "
      echo 'Waiting for MinIO...';
      until (mc alias set myminio http://minio:9000 admin password); do
        sleep 2;
      done;

      echo 'Creating buckets...';
      mc mb --ignore-existing myminio/datalake;
      mc mb --ignore-existing myminio/datalakehouse;
      mc mb --ignore-existing myminio/warehouse;
      mc mb --ignore-existing myminio/seed;

      echo 'Copying seed data...';
      if [ -d /seed ]; then
        mc cp --recursive /seed/* myminio/seed/ || true;
      fi;

      echo 'Applying IAM-style policies...';
      mc admin policy add myminio datalake-rw /policies/datalake-readwrite.json || true;
      mc admin user add myminio sparkuser sparkpassword || true;
      mc admin policy set myminio datalake-rw user=sparkuser || true;

      echo 'MinIO initialization complete.';
      "
    volumes:
      - ./minio-seed:/seed
      - ./minio-policies:/policies
    networks:
      - intro-network

  # ---------------------------------------------------------
  # Spark Master
  # ---------------------------------------------------------
  spark:
    platform: linux/x86_64
    image: alexmerced/spark35nb:latest
    container_name: spark
    depends_on:
      minio-init:
        condition: service_completed_successfully
      - nessie
    environment:
      - AWS_REGION=us-east-1
      - AWS_ACCESS_KEY_ID=admin
      - AWS_SECRET_ACCESS_KEY=password
      - SPARK_MASTER_HOST=spark
      - SPARK_MASTER_PORT=7077
      - SPARK_MASTER_WEBUI_PORT=8080
      - SPARK_HISTORY_OPTS=-Dspark.history.fs.logDirectory=/tmp/spark-events
      - SPARK_HOME=/opt/spark
    ports:
      - "8080:8080"
      - "7077:7077"
      - "4040-4045:4040-4045"
      - "18080:18080"
      - "8888:8888"
    volumes:
      - ./notebook-seed:/workspace/seed-data
    entrypoint: >
      /bin/bash -c "
      /opt/spark/sbin/start-master.sh && \
      mkdir -p /tmp/spark-events && \
      start-history-server.sh && \
      jupyter lab --ip=0.0.0.0 --port=8888 --no-browser --allow-root --NotebookApp.token='' --NotebookApp.password='' && \
      tail -f /dev/null
      "
    networks:
      - intro-network

  # ---------------------------------------------------------
  # Spark Worker
  # ---------------------------------------------------------
  spark-worker:
    platform: linux/x86_64
    image: alexmerced/spark35nb:latest
    container_name: spark-worker
    depends_on:
      - spark
    environment:
      - AWS_REGION=us-east-1
      - AWS_ACCESS_KEY_ID=admin
      - AWS_SECRET_ACCESS_KEY=password
      - SPARK_WORKER_WEBUI_PORT=8081
      - SPARK_HOME=/opt/spark
    entrypoint: >
      /bin/bash -c "
      /opt/spark/sbin/start-worker.sh spark://spark:7077 && \
      tail -f /dev/null
      "
    networks:
      - intro-network

  # ---------------------------------------------------------
  # Dremio
  # ---------------------------------------------------------
  dremio:
    platform: linux/x86_64
    image: dremio/dremio-oss:latest
    container_name: dremio
    environment:
      - DREMIO_JAVA_SERVER_EXTRA_OPTS=-Dpaths.dist=file:///opt/dremio/data/dist
    ports:
      - "9047:9047"
      - "31010:31010"
      - "32010:32010"
      - "45678:45678"
    networks:
      - intro-network

# ---------------------------------------------------------
# Network
# ---------------------------------------------------------
networks:
  intro-network:
